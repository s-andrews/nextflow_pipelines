#!/usr/bin/env nextflow
nextflow.enable.dsl=2

params.outdir = "."
params.help = false
params.bisulfite = false
params.hic = false
params.snp_file = "" 


// Show help message and exit
if (params.help){
    helpMessage()
    exit 0
}

if (params.snp_file == "" || params.snp_file == null) {
    println("snp file required - please specify with --snp_file\nExiting...\n")
    exit 1
} 

snp_file = file(params.snp_file)

if(snp_file.exists()) {
    println("Found snp: ${snp_file}")
} else {
    println("Couldn't find snp file ${snp_file} \nExiting...\n")
    exit 1
}

if (args[0] == "" || args[0] == null) {
    println("Couldn't find bam file, supply one as the final argument \nExiting...\n")
    exit 1
} else {
    bam_file = file(args[0])
}

if(bam_file.exists()) {
    println("Found bam: ${bam_file}")
} else {
    println("Couldn't find bam file ${bam_file} \nExiting...\n")
    exit 1
}

include { SNP_SPLIT }               from './nf_modules/snpsplit.mod.nf'


workflow {

    main:

        SNP_SPLIT(params.outdir, snp_file, bam_file, params.bisulfite, params.hic)
       
}

workflow.onComplete {

    def msg = """\
        Pipeline execution summary
        ---------------------------
        Completed at: ${workflow.complete}
        Duration    : ${workflow.duration}
        Success     : ${workflow.success}
        workDir     : ${workflow.workDir}
        exit status : ${workflow.exitStatus}
        """
    .stripIndent()

    sendMail(to: "${workflow.userName}@babraham.ac.uk", subject: 'Minimal pipeline execution report', body: msg)
}

def helpMessage() {
 
    log.info"""
    >>
    
    
    SYNOPSIS:
    
    This workflow runs SNPsplit (by default on the Babraham stone cluster). 
    

    =========================================================================================================


    USAGE:
    
    nf_snpsplit [options] --snp_file <.txt.gz file>  <mapped.bam>
    

    Mandatory arguments:
    ====================

      <mapped.bam>                       bam file mapped to N-masked genome

      --snp_file  [str]                  txt.gz file containing SNPs 


    Tool-Specific Options:
    ======================

      --bisulfite                        To run SNPsplit in bisulfite mode  [Default: Off]

      --hic                              To run SNPsplit on hiC data        [Default: Off]

    Other Options:
    ==============

      --outdir [str]                  Path to the output directory. [Default: current working directory]

      --help                          Displays this help message and exits.

    Workflow Options:
    =================

    Please note the single '-' hyphen for the following options!

      -resume                         If a pipeline workflow has been interrupted or stopped (e.g. by accidentally closing a laptop),
                                      this option will attempt to resume the workflow at the point it got interrupted by using
                                      Nextflow's caching mechanism. This may save a lot of time.

      -bg                             Sends the entire workflow into the background, thus disconnecting it from the terminal session.
                                      This option launches a daemon process (which will keep running on the headnode) that watches over
                                      your workflow, and submits new jobs to the SLURM queue as required. Use this option for big pipeline
                                      jobs, or whenever you do not want to watch the status progress yourself. Upon completion, the
                                      pipeline will send you an email with the job details. This option is HIGHLY RECOMMENDED!

      -process.executor=local         Temporarily changes where the workflow is executed to the 'local' machine. See also Nextflow config
                                      file for more details. [Default: slurm] 
    

    <<
    """.stripIndent()

}
